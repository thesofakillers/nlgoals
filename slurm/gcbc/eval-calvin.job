#!/bin/bash

#SBATCH --partition=gpu
#SBATCH --gres=gpu:1
#SBATCH --job-name=GCBC-EVAL
#SBATCH --ntasks=1
#SBATCH --cpus-per-task=18
#SBATCH --time=12:00:00
#SBATCH --mem-per-gpu=120G
#SBATCH --output=slurm/outputs/gcbc_eval_%A.out
#SBATCH --constraint=scratch-node

source "./slurm/.secrets"

source_path=/scratch-shared/gstarace/repos/thesis/data/calvin/task_D_D.zip
source ./slurm/setup_calvin.sh $source_path

module purge
module load 2022
module load Anaconda3/2022.05

source activate nlgoals

confs_path=$HOME/repos/thesis/src/nlgoals/data/calvin/repo/conf
calvin_env_path=$HOME/repos/calvin_env

srun python src/nlgoals/run/eval-calvin.py \
  --model_variant CALVIN \
  --model_checkpoint checkpoints/gcbc/GCBC-CALVIN-s1.ckpt \
  --data.config_name default.yaml \
  --data.data_dir=$data_dir \
  --data.num_workers 4 \
  --data.batch_size 16 \
  --data.shared_memory True \
  --clipt_checkpoint checkpoints/clipt/clipt-v1.ckpt \
  --rollout_steps 240 \
  --rollout_cfg_path $confs_path/callbacks/rollout/default.yaml \
  --task_oracle_cfg $confs_path/callbacks/rollout/tasks/new_playtable_tasks.yaml \
  --urdf_data_dir $calvin_env_path/data/ \
  --egl_dir_path $calvin_env_path/egl_check/
